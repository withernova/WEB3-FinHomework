<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ™ºå¯»å½’é€”-ç”¨æˆ·æ³¨å†Œ</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../static/layuimini/lib/layui-v2.5.5/css/layui.css" media="all">
    <style>
        /* åŸºç¡€æ ·å¼ */
        html, body {
            height: 100%;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        /* èƒŒæ™¯è§†é¢‘ */
        #background-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            z-index: -1;
            object-fit: cover;
        }
        
        /* ä¸»ä½“å®¹å™¨ */
        .main-body {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 430px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }
        
        /* æ³¨å†Œè¡¨å•é¡¶éƒ¨ */
        .register-header {
            height: 120px;
            background-color: #007bff;
            color: #fff;
            text-align: center;
            line-height: 120px;
            font-size: 28px;
            position: relative;
            border-radius: 12px 12px 0 0;
        }
        
        .register-header .bg1 {
            display: inline-block;
            width: 74px;
            height: 74px;
            background: #fff;
            opacity: .1;
            border-radius: 0 74px 0 0;
            position: absolute;
            left: 0;
            top: 43px;
        }
        
        .register-header .bg2 {
            display: inline-block;
            width: 94px;
            height: 94px;
            background: #fff;
            opacity: .1;
            border-radius: 50%;
            position: absolute;
            right: -16px;
            top: -16px;
        }
        
        /* æ³¨å†Œè¡¨å•å†…å®¹ */
        .register-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 0 0 12px 12px;
        }
        
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-group .icon {
            display: inline-block;
            width: 25px;
            height: 25px;
            position: absolute;
            left: 10px;
            top: 8px;
            color: #007bff;
        }
        
        .form-group input {
            width: 100%;
            height: 40px;
            border: none;
            border-bottom: 1px solid #dae1e6;
            padding-left: 40px;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            border-bottom-color: #007bff;
        }
        
        /* éªŒè¯ç åŒºåŸŸ */
        .verification-code {
            display: flex;
            position: relative;
            margin-bottom: 25px;
        }
        
        .verification-code input {
            flex: 1;
            height: 40px;
            border: none;
            border-bottom: 1px solid #dae1e6;
            padding-left: 40px;
            font-size: 14px;
            outline: none;
        }
        
        .verification-code button {
            width: 120px;
            height: 36px;
            background: none;
            border: 1px solid #007bff;
            border-radius: 4px;
            color: #007bff;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .verification-code button:hover {
            background-color: #007bff;
            color: white;
        }
        
        .verification-code button:disabled {
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
        }
        
        /* èº«ä»½é€‰æ‹©åŒºåŸŸ */
        .role-container {
            margin-bottom: 25px;
        }
        
        .role-title {
            margin-bottom: 10px;
            color: #646464;
            font-size: 14px;
        }
        
        .role-options {
            display: flex;
            justify-content: space-between;
        }
        
        .role-option {
            flex: 1;
            height: 45px;
            border: 1px solid #dae1e6;
            border-radius: 5px;
            text-align: center;
            line-height: 45px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 5px;
        }
        
        .role-option:first-child {
            margin-left: 0;
        }
        
        .role-option:last-child {
            margin-right: 0;
        }
        
        .role-option.selected {
            border-color: #007bff;
            background-color: #f0f7ff;
            color: #007bff;
        }
        
        /* å›¾å½¢éªŒè¯ç  */
        .captcha-group {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .captcha-group input {
            flex: 1;
            height: 40px;
            border: none;
            border-bottom: 1px solid #dae1e6;
            padding-left: 40px;
            font-size: 14px;
            outline: none;
        }
        
        #canvas {
            width: 120px;
            height: 40px;
            border: 1px solid #e6e6e6;
            cursor: pointer;
            margin-left: 10px;
        }
        
        /* åè®®é€‰æ‹© */
        .agreement {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            color: #9abcda;
            font-size: 12px;
        }
        
        .agreement-checkbox {
            width: 16px;
            height: 16px;
            border: 1px solid #41d1d1;
            border-radius: 2px;
            margin-right: 8px;
            position: relative;
            cursor: pointer;
        }
        
        .agreement-checkbox.checked::after {
            content: "âœ“";
            position: absolute;
            top: -1px;
            left: 2px;
            color: #007bff;
        }
        
        .agreement a {
            color: #007bff;
            text-decoration: none;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .register-btn {
            width: 100%;
            height: 45px;
            background-color: #007bff;
            border-radius: 22px;
            color: #fff;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .register-btn:hover {
            background-color: #0069d9;
        }
        
        /* ç™»å½•é“¾æ¥ */
        .login-link {
            text-align: center;
            font-size: 14px;
            color: #646464;
        }
        
        .login-link a {
            color: #007bff;
            text-decoration: none;
            margin-left: 5px;
        }
        
        /* å¯†ç å¯è§æ€§å¼€å…³ */
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 10px;
            cursor: pointer;
            color: #ccc;
        }
        
        .toggle-password:hover {
            color: #007bff;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media screen and (max-width: 480px) {
            .main-body {
                width: 90%;
            }
        }
        
        /* è¡¨å•å­—æ®µå›¾æ ‡ */
        .icon-user:before {
            content: "ğŸ‘¤";
        }
        
        .icon-lock:before {
            content: "ğŸ”’";
        }
        
        .icon-phone:before {
            content: "ğŸ“±";
        }
        
        .icon-location:before {
            content: "ğŸ“";
        }
        
        .icon-code:before {
            content: "ğŸ”‘";
        }
    </style>
</head>
<body>
<video autoplay muted loop id="background-video">
    <source src="../static/img/9OLD.mp4" type="video/mp4">
</video>

<div class="main-body">
    <div class="register-header">
        <span>æ™ºå¯»å½’é€”-ç”¨æˆ·æ³¨å†Œ</span>
        <span class="bg1"></span>
        <span class="bg2"></span>
    </div>
    
    <div class="register-content">
        <form id="registerForm" class="layui-form">
            <!-- ç”¨æˆ·å -->
            <div class="form-group">
                <span class="icon icon-user"></span>
                <input type="text" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" maxlength="24" autocomplete="off" lay-verify="required"/>
            </div>
            
            <!-- å¯†ç  -->
            <div class="form-group">
                <span class="icon icon-lock"></span>
                <input type="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " maxlength="20" autocomplete="off" lay-verify="required"/>
                <span class="toggle-password" id="togglePassword">ğŸ‘</span>
            </div>
            
            <!-- ç¡®è®¤å¯†ç  -->
            <div class="form-group">
                <span class="icon icon-lock"></span>
                <input type="password" name="confirmPassword" placeholder="è¯·ç¡®è®¤å¯†ç " maxlength="20" autocomplete="off" lay-verify="required"/>
            </div>
            
            <!-- æ‰‹æœºå·ç  -->
            <div class="form-group">
                <span class="icon icon-phone"></span>
                <input type="text" name="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " maxlength="11" autocomplete="off" lay-verify="required|phone"/>
            </div>
            
            <!-- çŸ­ä¿¡éªŒè¯ç  -->
            <div class="verification-code">
                <span class="icon icon-code"></span>
                <input type="text" name="verificationCode" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6" autocomplete="off" lay-verify="required"/>
                <button type="button" id="sendCodeBtn">è·å–éªŒè¯ç </button>
            </div>
            
            <!-- èº«ä»½é€‰æ‹© -->
            <div class="role-container">
                <div class="role-title">è¯·é€‰æ‹©æ‚¨çš„èº«ä»½:</div>
                <div class="role-options">
                    <div class="role-option" data-role="family">å®¶å±</div>
                    <div class="role-option" data-role="rescuer">æœæ•‘å¿—æ„¿è€…</div>
                </div>
                <input type="hidden" name="userType" value="">
            </div>
            
            <!-- åŸºç¡€ä¸ªäººä¿¡æ¯ - å§“å -->
            <div class="form-group role-specific-field" id="nameField">
                <span class="icon icon-user"></span>
                <input type="text" name="name" placeholder="è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å" maxlength="20" autocomplete="off" lay-verify="required"/>
            </div>
            
            <!-- å¿—æ„¿è€…ç‰¹æœ‰ä¿¡æ¯ - æ‰€åœ¨åœ°åŒº -->
            <div class="form-group role-specific-field" id="locationField" style="display:none;">
                <span class="icon icon-location"></span>
                <input type="text" name="location" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰€åœ¨åœ°åŒº" maxlength="50" autocomplete="off"/>
            </div>
            
            <!-- å›¾å½¢éªŒè¯ç  -->
            <div class="captcha-group">
                <span class="icon icon-code"></span>
                <input type="text" name="captcha" id="captcha" placeholder="è¯·è¾“å…¥å›¾å½¢éªŒè¯ç " maxlength="4" autocomplete="off" lay-verify="required"/>
                <canvas id="canvas" width="120" height="40"></canvas>
            </div>
            
            <!-- ç”¨æˆ·åè®® -->
            <div class="agreement">
                <div class="agreement-checkbox" id="agreementCheckbox"></div>
                <span>æˆ‘å·²é˜…è¯»å¹¶åŒæ„<a href="javascript:void(0);">ç”¨æˆ·åè®®</a></span>
            </div>
            
            <!-- æ³¨å†ŒæŒ‰é’® -->
            <button class="register-btn" type="button" id="registerBtn">ç«‹å³æ³¨å†Œ</button>
            
            <!-- ç™»å½•é“¾æ¥ -->
            <div class="login-link">
                <span>å·²æœ‰è´¦å·ï¼Ÿ</span>
                <a href="login.html">ç«‹å³ç™»å½•</a>
            </div>
        </form>
    </div>
</div>

<script src="../static/layuimini/lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script>
layui.use(['form', 'jquery', 'layer'], function() {
    var $ = layui.jquery,
        form = layui.form,
        layer = layui.layer;
    
    // åˆå§‹åŒ–å˜é‡
    var show_num = []; // å›¾å½¢éªŒè¯ç 
    var isAgreed = false; // æ˜¯å¦åŒæ„åè®®
    var countdown = 60; // çŸ­ä¿¡éªŒè¯ç å€’è®¡æ—¶
    var timer = null; // å€’è®¡æ—¶å®šæ—¶å™¨
    
    // é¡µé¢åŠ è½½å®Œæˆåï¼Œåˆå§‹åŒ–å›¾å½¢éªŒè¯ç å’Œé»˜è®¤é€‰æ‹©å®¶å±èº«ä»½
    $(function() {
        // ç”Ÿæˆå›¾å½¢éªŒè¯ç 
        drawCaptcha();
        
        // é»˜è®¤é€‰æ‹©"å®¶å±"èº«ä»½
        $('.role-option[data-role="family"]').click();
    });
    
    // å¯†ç å¯è§æ€§åˆ‡æ¢
    $('#togglePassword').on('click', function() {
        var passwordInput = $('input[name="password"]');
        if (passwordInput.attr('type') === 'password') {
            passwordInput.attr('type', 'text');
            $(this).text('ğŸ”’');
        } else {
            passwordInput.attr('type', 'password');
            $(this).text('ğŸ‘');
        }
    });
    
    // èº«ä»½é€‰æ‹©
    $('.role-option').on('click', function() {
        $('.role-option').removeClass('selected');
        $(this).addClass('selected');
        
        var role = $(this).data('role');
        $('input[name="userType"]').val(role);
        
        // æ˜¾ç¤º/éšè—ç‰¹å®šå­—æ®µ
        if (role === 'rescuer') {
            $('#locationField').show();
        } else {
            $('#locationField').hide();
            // æ¸…ç©ºéšè—å­—æ®µçš„å€¼
            $('input[name="location"]').val('');
        }
        
        // æ‰“å°å½“å‰é€‰æ‹©çš„è§’è‰²å’Œç›¸å…³å­—æ®µçŠ¶æ€
        console.log('é€‰æ‹©è§’è‰²:', role);
        console.log('å§“åå­—æ®µå¯è§:', $('#nameField').is(':visible'));
        console.log('åœ°åŒºå­—æ®µå¯è§:', $('#locationField').is(':visible'));
    });
    
    // ç”¨æˆ·åè®®é€‰æ‹©
    $('#agreementCheckbox').on('click', function() {
        isAgreed = !isAgreed;
        if (isAgreed) {
            $(this).addClass('checked');
        } else {
            $(this).removeClass('checked');
        }
    });
    
    // å›¾å½¢éªŒè¯ç ç‚¹å‡»åˆ·æ–°
    $('#canvas').on('click', function() {
        drawCaptcha();
    });
    
    // ç”Ÿæˆå›¾å½¢éªŒè¯ç å‡½æ•°
    function drawCaptcha() {
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        canvas.width = 120;
        canvas.height = 40;

        // æ¸…ç©ºç”»å¸ƒ
        context.clearRect(0, 0, canvas.width, canvas.height);

        // è®¾ç½®èƒŒæ™¯è‰²
        context.fillStyle = "#f3f6fa";
        context.fillRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶å¹²æ‰°çº¿
        for (var i = 0; i < 6; i++) {
            context.strokeStyle = randomColor(180, 240);
            context.beginPath();
            context.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
            context.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
            context.stroke();
        }

        // ç»˜åˆ¶å¹²æ‰°ç‚¹
        for (var i = 0; i < 40; i++) {
            context.fillStyle = randomColor(150, 200);
            context.beginPath();
            context.arc(Math.random() * canvas.width, Math.random() * canvas.height, 1, 0, 2 * Math.PI);
            context.fill();
        }

        // ç»˜åˆ¶éªŒè¯ç 
        show_num = []; // ä½¿ç”¨å…¨å±€å˜é‡ï¼
        var codes = "ABCDEFGHJKLMNPQRSTWXYZabcdefhijkmnprstwxyz2345678";
        for (var i = 0; i < 4; i++) {
            var charIndex = Math.floor(Math.random() * codes.length);
            var char = codes.charAt(charIndex);
            show_num.push(char.toLowerCase());

            var x = 20 + i * 25;
            var y = 25 + Math.random() * 8;
            var deg = Math.random() * 30 * Math.PI / 180;

            context.font = "bold 24px Arial";
            context.translate(x, y);
            context.rotate(deg);
            context.fillStyle = randomColor(50, 120);
            context.fillText(char, 0, 0);
            context.rotate(-deg);
            context.translate(-x, -y);
        }
        // æ‰“å°éªŒè¯ç ï¼Œä¾¿äºè°ƒè¯•
        console.log("éªŒè¯ç :", show_num.join(""));
    }
        
    // ç”Ÿæˆéšæœºé¢œè‰²
    function randomColor(min, max) {
        var r = Math.floor(Math.random() * (max - min + 1) + min);
        var g = Math.floor(Math.random() * (max - min + 1) + min);
        var b = Math.floor(Math.random() * (max - min + 1) + min);
        return "rgb(" + r + "," + g + "," + b + ")";
    }
    
    // çŸ­ä¿¡éªŒè¯ç å‘é€
    $('#sendCodeBtn').on('click', function() {
        var phone = $('input[name="phone"]').val();
        if (!phone) {
            layer.msg('è¯·è¾“å…¥æ‰‹æœºå·ç ');
            return;
        }
        
        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        if (!/^1\d{10}$/.test(phone)) {
            layer.msg('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
            return;
        }
        
        // å‘é€éªŒè¯ç è¯·æ±‚
        startCountdown($(this));
        
        // æ¨¡æ‹ŸAJAXè¯·æ±‚
        setTimeout(function() {
            layer.msg('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶');
        }, 1000);
    });
    
    // çŸ­ä¿¡éªŒè¯ç å€’è®¡æ—¶
    function startCountdown(btn) {
        if (countdown === 0) {
            btn.removeAttr("disabled");
            btn.text("è·å–éªŒè¯ç ");
            countdown = 60;
            clearTimeout(timer);
        } else {
            btn.attr("disabled", true);
            btn.text("é‡æ–°å‘é€(" + countdown + ")");
            countdown--;
            timer = setTimeout(function() {
                startCountdown(btn);
            }, 1000);
        }
    }
    
    // æ³¨å†ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('#registerBtn').on('click', function() {
        // æ‰‹åŠ¨è§¦å‘è¡¨å•éªŒè¯
        collectAndValidateForm();
    });
    
    // æ”¶é›†è¡¨å•æ•°æ®å¹¶éªŒè¯
    function collectAndValidateForm() {
        // æ”¶é›†è¡¨å•æ•°æ®
        var formData = {
            username: $('input[name="username"]').val(),
            password: $('input[name="password"]').val(),
            confirmPassword: $('input[name="confirmPassword"]').val(),
            phone: $('input[name="phone"]').val(),
            verificationCode: $('input[name="verificationCode"]').val(),
            userType: $('input[name="userType"]').val(),
            name: $('input[name="name"]').val(),
            location: $('input[name="location"]').val(),
            captcha: $('input[name="captcha"]').val()
        };
        
        // è¡¨å•éªŒè¯
        if (!formData.username) {
            layer.msg('è¯·è¾“å…¥ç”¨æˆ·å');
            return false;
        }
        
        if (!formData.password) {
            layer.msg('è¯·è¾“å…¥å¯†ç ');
            return false;
        }
        
        if (!formData.confirmPassword) {
            layer.msg('è¯·ç¡®è®¤å¯†ç ');
            return false;
        }
        
        if (formData.password !== formData.confirmPassword) {
            layer.msg('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
            return false;
        }
        
        if (!formData.phone) {
            layer.msg('è¯·è¾“å…¥æ‰‹æœºå·ç ');
            return false;
        }
        
        if (!/^1\d{10}$/.test(formData.phone)) {
            layer.msg('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
            return false;
        }
        
        if (!formData.verificationCode) {
            layer.msg('è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ');
            return false;
        }
        
        if (!formData.userType) {
            layer.msg('è¯·é€‰æ‹©ç”¨æˆ·èº«ä»½');
            return false;
        }
        
        if (!formData.name) {
            layer.msg('è¯·è¾“å…¥çœŸå®å§“å');
            return false;
        }
        
        if (formData.userType === 'rescuer' && !formData.location) {
            layer.msg('è¯·è¾“å…¥æ‰€åœ¨åœ°åŒº');
            return false;
        }
        
        if (!formData.captcha) {
            layer.msg('è¯·è¾“å…¥å›¾å½¢éªŒè¯ç ');
            return false;
        }
        
        // éªŒè¯å›¾å½¢éªŒè¯ç 
        var inputCaptcha = formData.captcha.toLowerCase();
        var correctCaptcha = show_num.join("");
        if (inputCaptcha !== correctCaptcha) {
            layer.msg('å›¾å½¢éªŒè¯ç é”™è¯¯');
            drawCaptcha();
            return false;
        }
        
        if (!isAgreed) {
            layer.msg('è¯·é˜…è¯»å¹¶åŒæ„ç”¨æˆ·åè®®');
            return false;
        }
        
        // æ‰“å°æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        console.log('è¡¨å•æ•°æ®:', formData);
        
        // æäº¤æ³¨å†Œè¯·æ±‚
        submitRegistration(formData);
    }
    
    // æäº¤æ³¨å†Œè¯·æ±‚
    function submitRegistration(formData) {
        // æ˜¾ç¤ºåŠ è½½å±‚
        var loadIndex = layer.load(1, {
            shade: [0.1, '#fff']
        });
        
        // å‘é€AJAXè¯·æ±‚
        $.ajax({
            url: '/api/users/register',
            type: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(res) {
                layer.close(loadIndex);
                
                // æ¨¡æ‹ŸæˆåŠŸå“åº”
                if (res && res.success) {
                    layer.msg('æ³¨å†ŒæˆåŠŸ', {
                        icon: 1,
                        time: 2000
                    }, function() {
                        window.location.href = '/';
                    });
                } else {
                    layer.msg(res.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', {
                        icon: 2
                    });
                }
            },
            error: function(xhr) {
                layer.close(loadIndex);
                
                // è°ƒè¯•ç”¨
                console.error('æ³¨å†Œè¯·æ±‚å¤±è´¥:', xhr);
                
                // ä¸ºäº†æµ‹è¯•é¡µé¢åŠŸèƒ½ï¼Œæ³¨é‡Šæ‰çœŸå®çš„é”™è¯¯å¤„ç†ï¼Œæ”¹ä¸ºæ¨¡æ‹ŸæˆåŠŸæ³¨å†Œ
                layer.msg('æ¨¡æ‹Ÿæ³¨å†ŒæˆåŠŸ', {
                    icon: 1,
                    time: 2000
                }, function() {
                    window.location.href = '/';
                });
                
                // å®é™…ä½¿ç”¨æ—¶å¯ä»¥å–æ¶ˆä¸‹é¢æ³¨é‡Š
                // layer.msg('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', {
                //     icon: 2
                // });
            }
        });
    }
});
</script>
</body>
</html>