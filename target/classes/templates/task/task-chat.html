<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <title>任务聊天</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" th:href="@{/layuimini/lib/layui-v2.5.5/css/layui.css}">
  <link rel="stylesheet" th:href="@{/layuimini/css/public.css}">
  <style>
    .chat-container {
      height: 400px;
      overflow-y: auto;
      background: #f9f9f9;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 15px;
    }
    .message-item {
      margin-bottom: 15px;
      clear: both;
    }
    .message-bubble {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 15px;
      position: relative;
      display: inline-block;
    }
    .message-sender {
      font-size: 12px;
      color: #999;
      margin-bottom: 3px;
    }
    .message-time {
      font-size: 11px;
      color: #aaa;
      margin-top: 5px;
      display: inline-block;
    }
    .message-sent {
      float: right;
    }
    .message-sent .message-bubble {
      background-color: #d9f4fe;
      border-top-right-radius: 5px;
      text-align: left;
    }
    .message-received {
      float: left;
    }
    .message-received .message-bubble {
      background-color: #f0f0f0;
      border-top-left-radius: 5px;
      text-align: left;
    }
    .message-image {
      max-width: 100%;
      max-height: 200px;
      border-radius: 5px;
      cursor: pointer;
    }
    .message-audio {
      width: 100%;
      max-width: 300px;
    }
    .message-system {
      text-align: center;
      margin: 15px 0;
    }
    .message-system .message-bubble {
      background-color: #f5f5f5;
      color: #888;
      padding: 5px 15px;
      border-radius: 15px;
      max-width: 80%;
      display: inline-block;
      float: none;
    }
    .badge-rescuer {
      background-color: #1E9FFF;
      color: #fff;
      font-size: 12px;
      padding: 2px 5px;
      border-radius: 3px;
      margin-right: 5px;
    }
    .badge-family {
      background-color: #FF5722;
      color: #fff;
      font-size: 12px;
      padding: 2px 5px;
      border-radius: 3px;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <!-- 聊天组件 -->
  <div th:fragment="taskChat(task, userType, userId, userName)">
    <div class="task-chat" th:if="${task.status == 'rescuing' || task.status == 'finished'}">
      <div class="layui-card">
        <div class="layui-card-header">
          <span>救援实时通讯</span>
          <span class="layui-badge layui-bg-green" style="margin-left: 10px;">实时</span>
        </div>
        <div class="layui-card-body">
          <!-- 聊天消息区域 -->
          <div id="chatContainer" class="chat-container">
            <div class="layui-text" style="text-align: center; color: #999; padding: 20px 0;">
              <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 加载消息历史...
            </div>
          </div>
          
          <!-- 输入区域 - 仅在救援中状态下可发送消息 -->
          <div th:if="${task.status == 'rescuing'}" class="chat-input-area">
            <div class="layui-form">
              <!-- 工具栏 -->
              <div class="chat-toolbar" style="margin-bottom: 10px;">
                <button type="button" class="layui-btn layui-btn-primary layui-btn-sm" id="uploadImage">
                  <i class="layui-icon">&#xe67c;</i> 图片
                </button>
                <button type="button" class="layui-btn layui-btn-primary layui-btn-sm" id="uploadAudio">
                  <i class="layui-icon">&#xe652;</i> 语音
                </button>
              </div>
              
              <!-- 消息输入框 -->
              <div class="layui-input-block" style="margin-left: 0;">
                <textarea id="messageInput" name="message" placeholder="输入消息..." class="layui-textarea" style="min-height: 80px; resize: none;"></textarea>
              </div>
              
              <!-- 预览区域 -->
              <div id="mediaPreview" style="display: none; margin: 10px 0; position: relative;">
                <!-- 图片预览 -->
                <img id="previewImage" style="max-width: 100%; max-height: 150px; border-radius: 4px; display: none;">
                
                <!-- 音频预览 -->
                <div id="audioPreview" style="display: none; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                  <i class="layui-icon">&#xe652;</i> 
                  <span id="audioFileName">语音文件</span>
                  <audio id="previewAudio" controls style="vertical-align: middle; margin-left: 10px; max-width: calc(100% - 100px);"></audio>
                </div>
                
                <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" id="clearMedia" style="position: absolute; top: 5px; right: 5px;">
                  <i class="layui-icon">&#xe640;</i>
                </button>
              </div>
              
              <!-- 发送按钮 -->
              <div style="text-align: right; margin-top: 10px;">
                <button type="button" class="layui-btn" id="sendMessage">发送</button>
              </div>
            </div>
          </div>
          
          <!-- 已完成任务提示 -->
          <div th:if="${task.status == 'finished'}" class="layui-text" style="text-align: center; color: #999; padding: 10px; background: #f0f0f0; border-radius: 5px;">
            <i class="layui-icon layui-icon-ok-circle"></i> 该任务已完成，无法继续发送消息
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
        /**
     * 任务聊天组件
     * @param {Object} config 配置信息
     *   - taskId: 任务ID
     *   - userId: 当前用户ID
     *   - userType: 用户类型（rescuer或family）
     *   - userName: 用户名称
     *   - taskStatus: 任务状态
     */
    function initTaskChat(config) {
      var taskId = config.taskId;
      var userId = config.userId;
      var userType = config.userType;
      var userName = config.userName;
      var taskStatus = config.taskStatus;
      
      var mediaType = null;  // 'image' 或 'audio'
      var mediaData = null;  // 媒体URL
      
      var lastMessageId = 0;
      var isFirstLoad = true;
      var isLoading = false;
      var autoRefreshTimer = null;
      
      // 初始加载消息
      loadMessages();
      
      // 设置自动刷新 (如果任务状态是救援中)
      if(taskStatus === 'rescuing') {
        autoRefreshTimer = setInterval(function() {
          refreshNewMessages();
        }, 5000); // 每5秒刷新一次
      }
      
      // 页面关闭时清除定时器
      $(window).on('beforeunload', function() {
        if(autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
        }
      });
      
      // 加载历史消息
      function loadMessages() {
        if(isLoading) return;
        isLoading = true;
        
        $('#chatContainer').html('<div class="layui-text" style="text-align: center; color: #999; padding: 20px 0;"><i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 加载消息历史...</div>');
        
        $.ajax({
          url: '/task/messages/' + taskId,
          type: 'GET',
          data: {
            before: lastMessageId > 0 ? lastMessageId : null,
            limit: 50
          },
          success: function(res) {
            isLoading = false;
            
            if(res.code === 0) {
              var messages = res.data.messages;
              $('#chatContainer').empty();
              
              if(messages.length === 0) {
                $('#chatContainer').html('<div class="message-system"><div class="message-bubble">暂无消息记录</div></div>');
                return;
              }
              
              // 添加系统消息
              $('#chatContainer').append('<div class="message-system"><div class="message-bubble">任务通讯已开始</div></div>');
              
              // 渲染消息
              messages.forEach(function(msg) {
                appendMessage(msg, false);
              });
              
              // 更新最后消息ID
              if(messages.length > 0) {
                lastMessageId = messages[0].id;
              }
              
              // 第一次加载时滚动到底部
              if(isFirstLoad) {
                scrollToBottom();
                isFirstLoad = false;
              }
            } else {
              $('#chatContainer').html('<div class="message-system"><div class="message-bubble">加载消息失败: ' + 
                                      (res.msg || '未知错误') + '</div></div>');
            }
          },
          error: function() {
            isLoading = false;
            $('#chatContainer').html('<div class="message-system"><div class="message-bubble">加载消息失败，请刷新页面重试</div></div>');
          }
        });
      }
      
      // 刷新新消息
      function refreshNewMessages() {
        if(isLoading) return;
        
        $.ajax({
          url: '/task/messages/' + taskId,
          type: 'GET',
          data: {
            after: lastMessageId,
            limit: 20
          },
          success: function(res) {
            if(res.code === 0) {
              var messages = res.data.messages;
              
              if(messages.length > 0) {
                // 渲染新消息
                messages.reverse().forEach(function(msg) {
                  appendMessage(msg, true);
                });
                
                // 更新最后消息ID
                lastMessageId = messages[messages.length - 1].id;
                
                // 如果用户当前在底部，则自动滚动
                if(isUserAtBottom()) {
                  scrollToBottom();
                } else {
                  // 显示新消息提示
                  showNewMessageAlert();
                }
              }
            }
          }
        });
      }
      
      // 添加消息到聊天窗口
      function appendMessage(message, isNew) {
        var msgData = JSON.parse(message.messageData);
        var isSelf = msgData.sender.id === userId;
        var msgClass = isSelf ? 'message-sent' : 'message-received';
        var msgTime = formatTime(new Date(msgData.timestamp));
        var badgeClass = msgData.sender.type === 'rescuer' ? 'badge-rescuer' : 'badge-family';
        var badgeText = msgData.sender.type === 'rescuer' ? '救援者' : '家属';
        
        var html = '<div class="message-item ' + msgClass + '" data-id="' + message.id + '">';
        
        if(!isSelf) {
          html += '<div class="message-sender">' +
                  '<span class="' + badgeClass + '">' + badgeText + '</span>' +
                  msgData.sender.name +
                  '</div>';
        }
        
        html += '<div class="message-bubble">';
        
        // 根据消息类型渲染不同内容
        if(msgData.type === 'text') {
          html += '<div class="message-text">' + escapeHtml(msgData.content) + '</div>';
        } else if(msgData.type === 'image' && msgData.media && msgData.media.url) {
          html += '<div class="message-image-container">' +
                  '<img src="' + msgData.media.url + '" class="message-image" onclick="previewImage(this.src)">' +
                  '</div>';
          if(msgData.content) {
            html += '<div class="message-text" style="margin-top: 5px;">' + escapeHtml(msgData.content) + '</div>';
          }
        } else if(msgData.type === 'audio' && msgData.media && msgData.media.url) {
          html += '<div class="message-audio-container">' +
                  '<audio controls class="message-audio" src="' + msgData.media.url + '"></audio>' +
                  '</div>';
          if(msgData.content) {
            html += '<div class="message-text" style="margin-top: 5px;">' + escapeHtml(msgData.content) + '</div>';
          }
        }
        
        html += '<div class="message-time">' + msgTime + '</div>';
        html += '</div></div>';
        
        if(isNew) {
          $('#chatContainer').append(html);
        } else {
          $('#chatContainer').prepend(html);
        }
      }
      
      // 发送消息
      $('#sendMessage').on('click', function() {
        var content = $('#messageInput').val().trim();
        
        if(!content && !mediaData) {
          layer.msg('请输入消息内容或添加媒体', {icon: 2});
          return;
        }
        
        // 构建消息数据
        var msgData = {
          sender: {
            id: userId,
            type: userType,
            name: userName
          },
          content: content,
          type: mediaType || 'text',
          timestamp: new Date().getTime()
        };
        
        if(mediaData) {
          msgData.media = {
            url: mediaData
          };
        }
        
        // 发送请求
        $.ajax({
          url: '/task/send-message',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            taskId: taskId,
            messageData: JSON.stringify(msgData)
          }),
          beforeSend: function() {
            $('#sendMessage').prop('disabled', true).text('发送中...');
          },
          success: function(res) {
            $('#sendMessage').prop('disabled', false).text('发送');
            
            if(res.code === 0) {
              // 清空输入
              $('#messageInput').val('');
              clearMedia();
              
              // 预先显示消息
              var tempMessage = {
                id: 'temp-' + new Date().getTime(),
                messageData: JSON.stringify(msgData)
              };
              appendMessage(tempMessage, true);
              scrollToBottom();
              
              // 更新消息ID
              if(res.data && res.data.messageId) {
                lastMessageId = res.data.messageId;
              }
            } else {
              layer.msg(res.msg || '发送失败', {icon: 2});
            }
          },
          error: function() {
            $('#sendMessage').prop('disabled', false).text('发送');
            layer.msg('发送失败，请稍后重试', {icon: 2});
          }
        });
      });
      
      // 图片上传
      layui.upload.render({
        elem: '#uploadImage',
        url: '/upload/image',
        accept: 'images',
        acceptMime: 'image/*',
        before: function() {
          layer.load();
          clearMedia();
        },
        done: function(res) {
          layer.closeAll('loading');
          
          if(res.code === 0) {
            mediaType = 'image';
            mediaData = res.url;
            
            $('#previewImage').attr('src', mediaData).show();
            $('#audioPreview').hide();
            $('#mediaPreview').show();
          } else {
            layer.msg(res.msg || '上传失败', {icon: 2});
          }
        },
        error: function() {
          layer.closeAll('loading');
          layer.msg('上传出错', {icon: 2});
        }
      });
      
      // 音频上传
      layui.upload.render({
        elem: '#uploadAudio',
        url: '/upload/audio',
        accept: 'audio',
        acceptMime: 'audio/*',
        before: function() {
          layer.load();
          clearMedia();
        },
        done: function(res) {
          layer.closeAll('loading');
          
          if(res.code === 0) {
            mediaType = 'audio';
            mediaData = res.url;
            
            // 显示音频预览
            $('#previewAudio').attr('src', mediaData);
            $('#audioFileName').text(res.fileName || '语音文件');
            $('#audioPreview').show();
            $('#previewImage').hide();
            $('#mediaPreview').show();
          } else {
            layer.msg(res.msg || '上传失败', {icon: 2});
          }
        },
        error: function() {
          layer.closeAll('loading');
          layer.msg('上传出错', {icon: 2});
        }
      });
      
      // 清除媒体
      $('#clearMedia').on('click', function() {
        clearMedia();
      });
      
      // 清除媒体辅助函数
      function clearMedia() {
        mediaType = null;
        mediaData = null;
        $('#mediaPreview').hide();
        $('#previewImage').attr('src', '').hide();
        $('#audioPreview').hide();
        $('#previewAudio').attr('src', '');
      }
      
      // 滚动到底部
      function scrollToBottom() {
        var container = document.getElementById('chatContainer');
        container.scrollTop = container.scrollHeight;
      }
      
      // 检查用户是否在底部
      function isUserAtBottom() {
        var container = document.getElementById('chatContainer');
        return (container.scrollHeight - container.scrollTop - container.clientHeight) < 50;
      }
      
      // 显示新消息提示
      function showNewMessageAlert() {
        if($('#newMessageAlert').length === 0) {
          $('<div id="newMessageAlert" class="new-message-alert">' +
            '<button class="layui-btn layui-btn-sm layui-btn-normal">' +
            '<i class="layui-icon">&#xe601;</i> 新消息</button></div>')
            .appendTo('#chatContainer')
            .css({
              'position': 'absolute',
              'bottom': '10px',
              'left': '50%',
              'transform': 'translateX(-50%)',
              'z-index': '100',
              'text-align': 'center'
            })
            .on('click', function() {
              scrollToBottom();
              $(this).remove();
            });
        }
      }
      
      // 格式化时间
      function formatTime(date) {
        var today = new Date();
        var isToday = date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear();
        
        var hours = date.getHours().toString().padStart(2, '0');
        var minutes = date.getMinutes().toString().padStart(2, '0');
        
        if(isToday) {
          return hours + ':' + minutes;
        } else {
          var month = (date.getMonth() + 1).toString().padStart(2, '0');
          var day = date.getDate().toString().padStart(2, '0');
          return month + '-' + day + ' ' + hours + ':' + minutes;
        }
      }
      
      // HTML转义
      function escapeHtml(text) {
        if (!text) return '';
        var map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
      }
    }

    // 全局函数 - 图片预览
    function previewImage(src) {
      layui.layer.photos({
        photos: {
          "data": [{
            "src": src
          }]
        },
        anim: 5
      });
    }
  </script>
</body>
</html>