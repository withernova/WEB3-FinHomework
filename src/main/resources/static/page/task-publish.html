<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>任务发布</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,max-scale=1">
  <link rel="stylesheet" href="../layuimini/lib/layui-v2.5.5/css/layui.css">
  <link rel="stylesheet" href="../layuimini/css/public.css">
  <style>
    body{background:#f2f2f2;}
    .layuimini-container{margin:20px auto;background:#fff;border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);padding:20px;}
    .layui-input-inline{width:300px;}
    .view-progress-btn{background:#1c528a;color:#fff;}
    .view-progress-btn:hover{background:#0069d9;}
  </style>
</head>
<body>
<div class="layuimini-container">
  <div class="layuimini-main">
    <fieldset class="layui-elem-field layui-field-title" align="center">
      <legend>任务发布</legend>
    </fieldset>

    <form class="layui-form" id="taskForm">
      <!-- 走失人员姓名 -->
      <div class="layui-form-item">
        <label class="layui-form-label">走失姓名</label>
        <div class="layui-input-inline">
          <input type="text" name="lost_person_name" lay-verify="required"
                 placeholder="请输入姓名" autocomplete="off" class="layui-input">
        </div>
      </div>

      <!-- 走失时间 -->
      <div class="layui-form-item">
        <label class="layui-form-label">走失时间</label>
        <div class="layui-input-inline">
          <input type="text" name="lost_time" id="date1" lay-verify="required"
                 autocomplete="off" class="layui-input">
        </div>
      </div>

      <!-- 走失地点 -->
      <div class="layui-form-item">
        <label class="layui-form-label">走失地点</label>
        <div class="layui-input-inline">
          <input type="text" name="lost_province" lay-verify="required"
                 placeholder="省" autocomplete="off" class="layui-input">
        </div>
        <div class="layui-input-inline">
          <input type="text" name="lost_city" lay-verify="required"
                 placeholder="市" autocomplete="off" class="layui-input">
        </div>
        <div class="layui-input-inline">
          <input type="text" name="lost_area" lay-verify="required"
                 placeholder="区" autocomplete="off" class="layui-input">
        </div>
      </div>

      <!-- 具体地址 -->
      <div class="layui-form-item">
        <label class="layui-form-label">具体地址</label>
        <div class="layui-input-inline">
          <input type="text" name="specific_address" placeholder="街道/门牌号"
                 autocomplete="off" class="layui-input">
        </div>
      </div>

      <!-- 联系电话 -->
      <div class="layui-form-item">
        <label class="layui-form-label">联系人手机号</label>
        <div class="layui-input-inline">
          <input type="tel" name="contact_phone" lay-verify="required|phone"
                 autocomplete="off" class="layui-input">
        </div>
      </div>

      <!-- 上传图片 -->
      <div class="layui-form-item">
        <label class="layui-form-label">照片</label>
        <div class="layui-input-block">
          <button type="button" class="layui-btn view-progress-btn" id="uploadImage">上传图片</button>
          <div id="imagePreview" style="margin-top:10px;"></div>
        </div>
      </div>

      <!-- 上传语音 -->
      <div class="layui-form-item">
        <label class="layui-form-label">语音</label>
        <div class="layui-input-block">
          <button type="button" class="layui-btn view-progress-btn" id="uploadAudio">上传语音</button>
          <span id="audioPreview" style="margin-left:10px;color:#666;"></span>
        </div>
      </div>

      <!-- 操作按钮 -->
      <div class="layui-form-item" style="text-align:center;">
        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submitTask">立即发布</button>
        <button type="button" class="layui-btn layui-btn-warm" id="downloadBtn" disabled>下载报告</button>
        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
      </div>
    </form>
  </div>
</div>

<script src="../layuimini/lib/layui-v2.5.5/layui.js"></script>
<script src="../layuimini/lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script>
layui.use(['form','laydate','upload','layer'], function(){
  var form   = layui.form
      ,laydate= layui.laydate
      ,upload = layui.upload
      ,layer  = layui.layer;

  laydate.render({elem:'#date1', type:'datetime'});

  var uploadedImgUrl  = "";
  var uploadedAudioUrl= "";
  var reportUrl       = "";

  /* 图片上传 */
  upload.render({
    elem:'#uploadImage',
    url :'/upload/image',
    accept:'images',
    done:function(res){
      uploadedImgUrl = res.url;
      $('#imagePreview').html('<img src="'+res.url+'" width="120">');
    }
  });

  /* 语音上传 */
  upload.render({
    elem:'#uploadAudio',
    url :'/upload/audio',
    accept:'audio', exts:'mp3|wav|m4a',
    done:function(res){
      uploadedAudioUrl = res.url;
      $('#audioPreview').text('已上传：'+res.url.split("/").pop());
    }
  });

  /* 发布任务 */
  form.on('submit(submitTask)', function(data){
    var postData = data.field;
    postData.photo_url = uploadedImgUrl;
    postData.audio_url = uploadedAudioUrl;

    $.ajax({
      url : '/task/publish',
      type: 'POST',
      contentType:'application/json;charset=utf-8',
      data: JSON.stringify(postData),
      success:function(res){
        if(res.success){
          layer.msg('发布成功',{icon:1});
          // 保存报告地址并启用按钮
          reportUrl = res.reportUrl;
          $('#downloadBtn').prop('disabled', !reportUrl);
          // 清空表单
          $('#taskForm')[0].reset();
          $('#imagePreview').empty();
          $('#audioPreview').empty();
        }else{
          layer.msg(res.message || '发布失败',{icon:2});
        }
      }
    });
    return false;
  });

  /* 下载报告 */
  $('#downloadBtn').on('click',function () {
    if(reportUrl){
      window.open(reportUrl,'_blank');
    }else{
      layer.msg('暂无可下载的报告',{icon:0});
    }
  });
});
</script>
</body>
</html>
