<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>救援地图</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.9.6/dist/css/layui.css">
  <style>
    body { background: #f2f2f2; margin: 0; padding: 0; }
    .layuimini-container { margin: 20px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.1); padding: 20px; }
    .map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .map-title { font-size: 18px; font-weight: bold; }
    .map-toolbar { display: flex; gap: 10px; margin-bottom: 15px; }
    #map-container { width: 100%; height: 600px; border-radius: 5px; overflow: hidden; position: relative; }
    #map { width: 100%; height: 100%; }
    #draw-canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 99; pointer-events: none; display: none; }
    #draw-hint { position:absolute;left:50%;top:15px;z-index:100; font-size:14px;padding:6px 18px;transform:translateX(-50%); background:rgba(255,255,0,.85);border-radius:6px;display:none;}
    .map-legend { background: #fff; position: absolute; top: 10px; right: 10px; border-radius: 4px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); z-index: 100; font-size: 12px;}
    .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
    .legend-color { width: 16px; height: 16px; border-radius: 3px; margin-right: 8px; }
    .legend-text { color: #666; }
    .marker-info { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 5px; display: none; position:absolute; left:50%; top:80px; z-index:200; min-width:280px; transform:translateX(-50%);}
    .marker-info textarea { width: 100%; min-height: 80px; padding: 10px; border: 1px solid #e6e6e6; border-radius: 4px; margin-bottom: 10px; resize: none; }
    .color-options { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
    .type-options { display: flex; gap: 10px; margin-bottom: 15px; }
    .marker-actions { display: flex; justify-content: flex-end; gap: 10px; }
  </style>
  <!-- 高德地图API -->
  <script src="https://webapi.amap.com/maps?v=2.0&key=2a73ff764995703ff9e17cc103851a1e"></script>
</head>
<body>
<div class="layuimini-container">
  <div class="layuimini-main">
    <div class="map-header">
      <div class="map-title">救援地图</div>
    </div>
    <div class="map-toolbar">
      <button type="button" class="layui-btn layui-btn-normal" id="draw-area">绘制区域</button>
      <button type="button" class="layui-btn layui-btn-normal" id="draw-path">绘制路径</button>
      <button type="button" class="layui-btn layui-btn-normal" id="add-marker">添加标记</button>
      <button type="button" class="layui-btn layui-btn-warm" id="toggle-weather">天气图层</button>
      <button type="button" class="layui-btn layui-btn-primary" id="clear-current">清除当前</button>
    </div>
    <div id="map-container">
      <div id="map"></div>
      <canvas id="draw-canvas"></canvas>
      <div id="draw-hint">正在绘制，地图已锁定。单击添加，双击结束，ESC取消</div>
      <!-- 图例 -->
      <!-- <div class="map-legend">
        <div class="legend-title">图例说明</div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #FF5722;"></div>
          <div class="legend-text">危险区域</div>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #5FB878;"></div>
          <div class="legend-text">已搜索区域</div>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #1E9FFF;"></div>
          <div class="legend-text">搜索路径</div>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #FFB800;"></div>
          <div class="legend-text">兴趣点</div>
        </div>
      </div> -->
    </div>
    <!-- 标记信息输入区域 -->
    <div class="marker-info" id="marker-info">
      <div class="layui-form">
        <div class="layui-form-item">
          <label class="layui-form-label">描述</label>
          <div class="layui-input-block">
            <textarea id="marker-description" placeholder="请输入标记描述信息..." class="layui-textarea"></textarea>
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">类型</label>
          <div class="layui-input-block type-options">
            <input type="radio" name="marker-type" value="searched" title="已搜索区域" checked>
            <input type="radio" name="marker-type" value="danger" title="危险区域">
            <input type="radio" name="marker-type" value="poi" title="兴趣点">
            <input type="radio" name="marker-type" value="path" title="搜索路径">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">颜色</label>
          <div class="layui-input-block color-options">
            <input type="color" id="marker-color" value="#5FB878">
            <span id="color-preview" style="display:inline-block; width:20px; height:20px; background:#5FB878; border-radius:4px;"></span>
          </div>
        </div>
        <div class="layui-form-item marker-actions">
          <button type="button" class="layui-btn layui-btn-primary" id="cancel-marker">取消</button>
          <button type="button" class="layui-btn" id="save-marker">保存标记</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/layui@2.9.6/dist/layui.js"></script>
<script th:inline="javascript">
  var mapConfig = [[${mapConfig}]];
  var taskId = [[${taskId}]];
  var userName = '[[${userName}]]';
</script>
<script>
  var map = new AMap.Map('map', {
    center: [mapConfig.centerLng, mapConfig.centerLat],
    zoom: mapConfig.zoomLevel
  });
</script>
<script>
const TYPE_COLORS = {
  searched: '#5FB878',
  danger:   '#FF5722',
  path:     '#1E9FFF',
  poi:      '#FFB800'
};
const TYPE_FILL = {
  searched: 'rgba(95,184,120,0.18)',
  danger:   'rgba(255,87,34,0.13)',
  path:     'rgba(30,159,255,0.09)',
  poi:      'rgba(255,184,0,0.18)'
};

const TYPE_LABELS = {
  searched: '已搜索区域',
  danger: '危险区域',
  poi: '兴趣点',
  path: '搜索路径',
  marker: '标记'
};

let drawCanvas, drawCtx, drawHint;
let drawMode = null; // polygon|polyline|marker
let drawEnable = false;
let drawPoints = [];
let overlays = [];
let pendingDrawType = null;
let pendingDrawGeometry = null;

const API_SAVE = '/api/map/savemarker';
const API_LIST = '/api/map/markers/'; // + taskId

function resizeDrawCanvas() {
  const mapDom = document.getElementById('map');
  drawCanvas.width = mapDom.offsetWidth;
  drawCanvas.height = mapDom.offsetHeight;
  drawCanvas.style.width = mapDom.offsetWidth + "px";
  drawCanvas.style.height = mapDom.offsetHeight + "px";
  drawPolygonOnCanvas();
}

function drawPolygonOnCanvas() {
  drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
  if (drawPoints.length === 0 || !drawMode) return;
  const type = drawMode === 'polygon'
      ? $('input[name="marker-type"]:checked').val() || 'searched'
      : drawMode === 'polyline'
      ? 'path'
      : 'poi';
  const color = TYPE_COLORS[type];
  const fill = TYPE_FILL[type];

  if (drawMode === 'polygon' && drawPoints.length > 1) {
    drawCtx.strokeStyle = color;
    drawCtx.lineWidth = 2;
    drawCtx.fillStyle = fill;
    drawCtx.beginPath();
    drawCtx.moveTo(drawPoints[0].x, drawPoints[0].y);
    for(let i=1;i<drawPoints.length;i++) drawCtx.lineTo(drawPoints[i].x, drawPoints[i].y);
    drawCtx.closePath();
    drawCtx.stroke();
    if (drawPoints.length > 2) drawCtx.fill();
  }
  if (drawMode === 'polyline' && drawPoints.length > 1) {
    drawCtx.strokeStyle = color;
    drawCtx.lineWidth = 4;
    drawCtx.beginPath();
    drawCtx.moveTo(drawPoints[0].x, drawPoints[0].y);
    for(let i=1;i<drawPoints.length;i++) drawCtx.lineTo(drawPoints[i].x, drawPoints[i].y);
    drawCtx.stroke();
  }
  // 点渲染
  for(let pt of drawPoints){
    drawCtx.beginPath();
    drawCtx.arc(pt.x, pt.y, 6, 0, 2*Math.PI);
    drawCtx.fillStyle = color;
    drawCtx.fill();
    drawCtx.strokeStyle="#fff";
    drawCtx.lineWidth=2;
    drawCtx.stroke();
  }
  if(drawMode === 'marker' && drawPoints.length === 1){
    drawCtx.beginPath();
    drawCtx.arc(drawPoints[0].x, drawPoints[0].y, 10, 0, 2*Math.PI);
    drawCtx.fillStyle = color;
    drawCtx.fill();
    drawCtx.strokeStyle="#fff";
    drawCtx.lineWidth=3;
    drawCtx.stroke();
  }
}

function closeDrawCanvas() {
  drawEnable = false;
  drawMode = null;
  drawPoints = [];
  drawCanvas.style.display = 'none';
  drawCanvas.style.pointerEvents = 'none';
  drawHint.style.display = 'none';
  drawPolygonOnCanvas();
}

function openDrawCanvas(mode) {
  drawEnable = true;
  drawMode = mode;
  drawPoints = [];
  resizeDrawCanvas();
  drawCanvas.style.display = 'block';
  drawCanvas.style.pointerEvents = 'auto';
  drawHint.style.display = 'block';
  drawHint.innerText = mode==='polygon' ? '正在绘制区域，单击添加顶点，双击结束，ESC取消'
    : mode==='polyline' ? '正在绘制路径，单击添加节点，双击结束，ESC取消'
    : '点击地图添加标记点，ESC取消';
  drawPolygonOnCanvas();
}

function openMarkerInput(x, y, geometryType) {
  $('#marker-info').show();
  $('#marker-description').val('');
  $('#marker-color').val('#5FB878');
  $('#color-preview').css('background', '#5FB878');
  $('input[name="marker-type"][value="searched"]').prop('checked', true);
  $('#marker-info').data('pos', {x, y});
  $('#marker-info').data('geometryType', geometryType || 'Point');
}

// 用于多边形、路径弹窗：把弹窗显示到最后一个点正上方
function openAreaInput(points, geometryType) {
  // 取最后一个点
  let pt = points[points.length-1];
  openMarkerInput(pt.x, pt.y, geometryType);
  // 定位弹窗
  let infoBox = $('#marker-info');
  infoBox.show();
  let container = $('#map-container')[0];
  let left = pt.x - infoBox.outerWidth()/2;
  let top = pt.y - infoBox.outerHeight() - 16;
  // 防止超出边界
  left = Math.max(10, Math.min(left, container.offsetWidth-infoBox.outerWidth()-10));
  top = Math.max(10, top);
  infoBox.css({left:left+'px',top:top+'px'});
}

function closeMarkerInput() { $('#marker-info').hide(); }
function clearMapOverlays() {
  overlays.forEach(o=>o.setMap(null));
  overlays = [];
}

// 将像素点数组转经纬度数组
function pointsToLngLats(points){
  return points.map(pt=>{
    const lnglat = map.containerToLngLat([pt.x, pt.y]);
    return [lnglat.lng, lnglat.lat];
  });
}

function saveCurrentDraw() {
  if(drawMode === 'polygon' && drawPoints.length >= 3){
    pendingDrawType = 'polygon';
    pendingDrawGeometry = { type: "Polygon", coordinates: [pointsToLngLats(drawPoints)] };
    openAreaInput(drawPoints, 'Polygon');
    closeDrawCanvas();
  } else if(drawMode === 'polyline' && drawPoints.length >= 2) {
    pendingDrawType = 'polyline';
    pendingDrawGeometry = { type: "LineString", coordinates: pointsToLngLats(drawPoints) };
    openAreaInput(drawPoints, 'LineString');
    closeDrawCanvas();
  }
}

function saveToBackend(markerType, geometry, properties){
  $.ajax({
    url: API_SAVE,
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({
      taskId: taskId,
      markerType: markerType,
      geometry: JSON.stringify(geometry),
      properties: JSON.stringify(properties)
    }),
    success: function(res){
      if(res.code===0){
        layui.layer.msg('保存成功', {icon:1});
        renderMarker({
          markerType, geometry: JSON.stringify(geometry), properties: JSON.stringify(properties)
        });
      } else {
        layui.layer.msg('保存失败: '+(res.msg||'未知错误'), {icon:2});
      }
    },
    error: function(err){
      layui.layer.msg('网络错误，请重试', {icon:2});
    }
  });
}

// canvas生成彩色marker图标（圆点）
function createMarkerIcon(color) {
  let canvas = document.createElement('canvas');
  canvas.width = 32; canvas.height = 32;
  let ctx = canvas.getContext('2d');
  ctx.beginPath();
  ctx.arc(16, 16, 12, 0, 2 * Math.PI);
  ctx.fillStyle = color;
  ctx.shadowColor = "#888";
  ctx.shadowBlur = 3;
  ctx.fill();
  ctx.beginPath();
  ctx.arc(16, 16, 6, 0, 2 * Math.PI);
  ctx.fillStyle = "#fff";
  ctx.globalAlpha = 0.5;
  ctx.fill();
  ctx.globalAlpha = 1;
  return canvas.toDataURL();
}

// 渲染区域/路径/点
function renderMarker(marker){
  const geometry = typeof marker.geometry === 'string' ? JSON.parse(marker.geometry) : marker.geometry;
  let properties = {};
  if (marker.properties) {
    try { properties = JSON.parse(marker.properties); } catch(e) {}
  }
  let color = marker.color || properties.color || "#1E9FFF";
  let markerType = marker.markerType || properties.markerType || "marker";
  let description = marker.description || properties.description || "";
  let createdBy = marker.createdBy || properties.createdBy || "";

  let overlay = null;
  if(markerType === 'polygon'){
    overlay = new AMap.Polygon({
      path: geometry.coordinates[0],
      strokeColor: color,
      strokeWeight: 2,
      fillColor: color,
      fillOpacity: 0.3
    });
    overlay.setMap(map);
    overlay.on('click', function(e){
      showInfoWindow(markerType, description, createdBy, e.lnglat);
    });
  } else if(markerType === 'polyline'){
    overlay = new AMap.Polyline({
      path: geometry.coordinates,
      strokeColor: color,
      strokeWeight: 4
    });
    overlay.setMap(map);
    overlay.on('click', function(e){
      showInfoWindow(markerType, description, createdBy, e.lnglat);
    });
  } else if(markerType === 'marker' || geometry.type==='Point'){
    overlay = new AMap.Marker({
      position: geometry.coordinates,
      title: description,
      icon: new AMap.Icon({
        size: new AMap.Size(32, 32),
        image: createMarkerIcon(color),
        imageSize: new AMap.Size(32, 32)
      })
    });
    overlay.setMap(map);
    overlay.on('click', function(e){
      showInfoWindow(markerType, description, createdBy, geometry.coordinates);
    });
  }
  overlays.push(overlay);
}

function showInfoWindow(type, description, createdBy, lnglat){
  let info = `<div style="padding:10px;">
    <div style="font-weight:bold;margin-bottom:5px;">${TYPE_LABELS[type] || type || '标记'}</div>
    <div>${description}</div>
    <div style="font-size:12px;color:#999;margin-top:5px;">${createdBy?('创建者: '+createdBy):''}</div>
  </div>`;
  const infoWindow = new AMap.InfoWindow({content: info, offset: new AMap.Pixel(0, -20)});
  infoWindow.open(map, lnglat);
}

// 加载后端所有区域/路径/标记
function loadMarkers(){
  clearMapOverlays();
  $.ajax({
    url: API_LIST + taskId,
    type: 'GET',
    success: function(res){
      if(res.code===0 && res.data){
        res.data.forEach(renderMarker);
      }
    }
  });
}

$(document).ready(function(){

  drawCanvas = document.getElementById('draw-canvas');
  drawHint = document.getElementById('draw-hint');
  drawCtx = drawCanvas.getContext('2d');
  window.addEventListener('resize', resizeDrawCanvas);
  resizeDrawCanvas();

  // 加载后端数据
  loadMarkers();

  // 按钮绑定
  $('#draw-area').on('click', function(){ openDrawCanvas('polygon'); });
  $('#draw-path').on('click', function(){ openDrawCanvas('polyline'); });
  $('#add-marker').on('click', function(){ openDrawCanvas('marker'); });
  $('#clear-current').on('click', function(){ closeDrawCanvas(); });

  let weatherLayer = null;
  let weatherLayerVisible = false;

  $('#toggle-weather').on('click', function(){
    if(weatherLayerVisible){
      if(weatherLayer) map.remove(weatherLayer);
      weatherLayerVisible = false;
      $(this).text('天气图层');
    }else{
      weatherLayer = new AMap.WeatherLayer({ weather: 'clouds' }); // clouds|precipitation|radar
      map.add(weatherLayer);
      weatherLayerVisible = true;
      $(this).text('关闭天气');
    }
  });

  // canvas事件
  drawCanvas.addEventListener('mousedown', function(e){
    if(!drawEnable) return;
    const rect = drawCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    if(drawMode==='polygon' || drawMode==='polyline'){
      drawPoints.push({x,y});
      drawPolygonOnCanvas();
    }
    else if(drawMode==='marker'){
      drawPoints = [{x,y}];
      drawPolygonOnCanvas();
      openMarkerInput(x,y,'Point');
      // 定位弹窗
      let infoBox = $('#marker-info');
      infoBox.show();
      let container = $('#map-container')[0];
      let left = x - infoBox.outerWidth()/2;
      let top = y - infoBox.outerHeight() - 16;
      // 防止超出边界
      left = Math.max(10, Math.min(left, container.offsetWidth-infoBox.outerWidth()-10));
      top = Math.max(10, top);
      infoBox.css({left:left+'px',top:top+'px'});
      closeDrawCanvas();
    }
  });

  drawCanvas.addEventListener('dblclick', function(e){
    if(!drawEnable) return;
    if(drawMode==='polygon' && drawPoints.length>=3){
      saveCurrentDraw();
    }
    else if(drawMode==='polyline' && drawPoints.length>=2){
      saveCurrentDraw();
    }
  });
  document.addEventListener('keydown', function(e){
    if(drawEnable && e.key==='Escape'){
      closeDrawCanvas();
    }
  });

  // marker/区域/路径保存
  $('#save-marker').on('click', function(){
    let type = $('input[name="marker-type"]:checked').val() || 'searched';
    let color = $('#marker-color').val();
    let desc = $('#marker-description').val();
    let pos = $('#marker-info').data('pos');
    let geometryType = $('#marker-info').data('geometryType') || 'Point';

    if(geometryType==='Point'){
      const lnglat = map.containerToLngLat([pos.x, pos.y]);
      const geometry = { type: "Point", coordinates: [lnglat.lng, lnglat.lat] };
      const props = {
        color,
        markerType: type,
        description: desc,
        createdBy: userName
      };
      saveToBackend('marker', geometry, props);
    } else if(geometryType==='Polygon'){
      // 用pendingDrawGeometry
      const props = {
        color,
        markerType: type,
        description: desc,
        createdBy: userName
      };
      saveToBackend('polygon', pendingDrawGeometry, props);
      pendingDrawGeometry = null;
      pendingDrawType = null;
    } else if(geometryType==='LineString'){
      const props = {
        color,
        markerType: type,
        description: desc,
        createdBy: userName
      };
      saveToBackend('polyline', pendingDrawGeometry, props);
      pendingDrawGeometry = null;
      pendingDrawType = null;
    }
    closeMarkerInput();
  });
  $('#cancel-marker').on('click', function(){
    closeMarkerInput();
    pendingDrawGeometry = null;
    pendingDrawType = null;
  });

  // 类型颜色联动
  $('input[name="marker-type"]').on('change', function(){
    let type = $(this).val();
    let color = TYPE_COLORS[type];
    $('#marker-color').val(color);
    $('#color-preview').css('background', color);
  });
  $('#marker-color').on('input', function(){ $('#color-preview').css('background', $(this).val()); });
});
</script>
</body>
</html>